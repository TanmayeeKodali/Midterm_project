AGE >= 40 & AGE < 50 ~ 2,     # 40-49 years
AGE >= 50 ~ 3,                # 50+ years
TRUE ~ NA_real_
),
RACE4CAT = case_when(
RACE == 3 ~ 0,                # Non-Hispanic White
RACE == 4 ~ 1,                # Non-Hispanic Black
RACE %in% c(1, 2) ~ 2,        # Hispanic
RACE %in% c(6, 7) ~ 3,        # Other
TRUE ~ NA_real_
),
INCPOV3CAT = case_when(
INCPOV <= 1.3 ~ 1,            # Low income
INCPOV > 1.3 ~ 0,             # Not low income
TRUE ~ NA_real_
),
# --- Calculate average blood pressure ---
SBP = rowMeans(across(c(SBP1, SBP2, SBP3, SBP4)), na.rm = TRUE),
DBP = rowMeans(across(c(DBP1, DBP2, DBP3, DBP4)), na.rm = TRUE),
# --- Blood pressure questionnaire ---
BPQTOLD = case_when(
BPQ020 == 1 ~ 1,              # Told by doctor
BPQ020 == 2 ~ 0,              # Not told
TRUE ~ NA_real_
),
BPQMED = case_when(
BPQ050A == 1 ~ 1,             # Taking BP medication
BPQ050A == 2 ~ 0,             # Not taking medication
TRUE ~ NA_real_
),
# --- Behavioral variables ---
SMOKING = case_when(
SMQ020 == 1 ~ 1,              # Ever smoker (>=100 cigarettes)
SMQ020 == 2 ~ 0,              # Never smoker
TRUE ~ NA_real_
),
ALCOHOL = case_when(
ALQ101 == 1 ~ 1,              # >=12 drinks/year
ALQ101 == 2 ~ 0,              # <12 drinks/year
TRUE ~ NA_real_
),
# --- Lab-based mediators ---
KIDFUNCTION = case_when(
URXUCR >= 30 ~ 1,              # Reduced kidney function
URXUCR < 30 ~ 0,               # Normal kidney function
TRUE ~ NA_real_
),
INFLAMMATION = case_when(
LBXHSCRP >= 3 ~ 1,         # Elevated inflammation
LBXHSCRP < 3 ~ 0,          # Normal inflammation
TRUE ~ NA_real_
),
# --- EXPOSURE: Blood lead ---
BLOODLEAD = case_when(
LBXBPB >= 3.5 ~ 1,           # High blood lead
LBXBPB < 3.5 ~ 0,            # Low blood lead
TRUE ~ NA_real_
),
# --- OUTCOME: Hypertension (V6 - FINAL DEFINITION) ---
# HTN = Stage 1 BP (130/80) OR diagnosed/medicated
# No-HTN = Normal BP (<130/80) OR (not diagnosed AND not medicated)
HYPERTENSION_status = case_when(
# HTN if ANY of these are true
(SBP >= 130 | DBP >= 80) | (BPQTOLD == 1 | BPQMED == 1) ~ 1,
# No-HTN if ALL BP normal AND not told AND not on meds
(SBP < 130 & DBP < 80) | (BPQTOLD == 0 & BPQMED == 0) ~ 0,
# Only set to NA if truly missing data
is.na(SBP) | is.na(DBP) | is.na(BPQTOLD) | is.na(BPQMED) ~ NA_real_,
# Everyone else gets 0 (uncertain cases default to non-HTN)
TRUE ~ 0
),
# --- Composite body function (for descriptive purposes only) ---
BODY_FUNCTION = case_when(
KIDFUNCTION == 1 | INFLAMMATION == 1 ~ 1,
KIDFUNCTION == 0 & INFLAMMATION == 0 ~ 0,
TRUE ~ NA_real_
)
)
NHANES_V2 <- NHANES_V1 |>
mutate(
# --- STEP 1: Eligibility criteria ---
ADULT20 = case_when(AGE >= 20 ~ 1, AGE < 20 ~ 0, TRUE ~ NA_real_),
WTELIGIBLE = case_when(WTSH2YR != 0 & !is.na(WTSH2YR) ~ 1, TRUE ~ 0),
ELIGIBLESAMPLE = case_when(ADULT20 == 1 & WTELIGIBLE == 1 ~ 1, TRUE ~ 0),
# --- STEP 2: Missing data flags (no outcome-based exclusions) ---
EDUCATIONMISSING = if_else(is.na(EDU4CAT), 1, 0),
RACEMISSING = if_else(is.na(RACE4CAT), 1, 0),
INCOMEMISSING = if_else(is.na(INCPOV3CAT), 1, 0),
SEXMISSING = if_else(is.na(SEX), 1, 0),
BLOODLEADMISSING = if_else(is.na(BLOODLEAD), 1, 0),
URINEMISSING = if_else(is.na(URXUCR), 1, 0),
HSCRPMISSING = if_else(is.na(LBXHSCRP), 1, 0),
SMOKINGMISSING = if_else(is.na(SMOKING), 1, 0),
ALCOHOLMISSING = if_else(is.na(ALCOHOL), 1, 0),
# --- STEP 3: Exclusion criteria (WITHOUT outcome variables) ---
EXCLUSIONCRITERIA = if_else(
EDUCATIONMISSING == 1 | RACEMISSING == 1 | INCOMEMISSING == 1 |
SEXMISSING == 1 | BLOODLEADMISSING == 1 | URINEMISSING == 1 |
HSCRPMISSING == 1 | SMOKINGMISSING == 1 | ALCOHOLMISSING == 1,
1, 0
),
# --- STEP 4: Define analytic sample ---
ANALYTICSAMPLE = case_when(
ELIGIBLESAMPLE == 1 & EXCLUSIONCRITERIA == 0 ~ 1,
TRUE ~ 0
)
)
# Check sample size
cat("Analytic sample size (unweighted):", sum(NHANES_V2$ANALYTICSAMPLE == 1, na.rm = TRUE), "\n")
# Check outcome variability
cat("\nHypertension distribution in analytic sample:\n")
NHANES_V2 |>
filter(ANALYTICSAMPLE == 1) |>
count(HYPERTENSION_status) |>
mutate(percent = round(100 * n / sum(n), 1)) |>
print()
# Using the final analytic dataset
analytic_sample <- NHANES_V2 |>
filter(ANALYTICSAMPLE == 1)
cat("Final analytic sample size:", nrow(analytic_sample), "\n")
svy_design <- analytic_sample |>
as_survey_design(
ids = SDMVPSU,
strata = SDMVSTRA,
weights = WTSH2YR,
nest = TRUE
)
# Tests whether blood lead is associated with hypertension without adjustment
unadjusted_model <- svyglm(
HYPERTENSION_status ~ LBXBPB,
design = svy_design,
family = quasibinomial()
)
# View model summary
summary(unadjusted_model)
# Extract coefficients and convert to odds ratios
unadj_results <- tidy(unadjusted_model, conf.int = TRUE, exponentiate = TRUE)
print(unadj_results)
# Tests whether blood lead is independently associated with hypertension
# after controlling for confounders
adjusted_model <- svyglm(
HYPERTENSION_status ~ LBXBPB + AGE + SEX + RACE4CAT + EDU4CAT +
INCPOV3CAT + SMOKING + ALCOHOL,
design = svy_design,
family = quasibinomial()
)
# View model summary
summary(adjusted_model)
# Extract coefficients and convert to odds ratios
adj_results <- tidy(adjusted_model, conf.int = TRUE, exponentiate = TRUE)
print(adj_results)
# Extract blood lead OR from both models
unadj_or <- unadj_results %>% filter(term == "LBXBPB") %>% pull(estimate)
adj_or <- adj_results %>% filter(term == "LBXBPB") %>% pull(estimate)
# Calculate percent change
percent_change <- ((adj_or - unadj_or) / unadj_or) * 100
cat("\n=== BLOOD LEAD COEFFICIENT COMPARISON ===\n")
cat("Unadjusted OR:", round(unadj_or, 3), "\n")
cat("Adjusted OR:", round(adj_or, 3), "\n")
cat("Percent change:", round(percent_change, 1), "%\n")
class(analytic_sample$RACE4CAT)
class(analytic_sample$EDU4CAT)
# Function to format results with proper rounding
format_model_results <- function(model_results, model_name) {
model_results %>%
mutate(
OR = round(estimate, 2),  # Round to 2 decimals for readability
CI = sprintf("(%.2f, %.2f)", conf.low, conf.high),
p_value = case_when(
p.value < 0.001 ~ "<0.001",
p.value >= 0.001 & p.value < 0.01 ~ sprintf("%.3f", p.value),
TRUE ~ sprintf("%.2f", p.value)
),
model = model_name
) %>%
select(term, OR, CI, p_value, model)
}
# Format both models
unadj_formatted <- format_model_results(unadj_results, "Unadjusted")
adj_formatted <- format_model_results(adj_results, "Adjusted")
# Combine into wide format for Table 2
table2_data <- unadj_formatted %>%
full_join(adj_formatted, by = "term", suffix = c("_unadj", "_adj")) %>%
select(term,
OR_unadj, CI_unadj, p_value_unadj,
OR_adj, CI_adj, p_value_adj)
# Clean up variable names for display
table2_data <- table2_data %>%
mutate(
Variable = case_when(
term == "(Intercept)" ~ "Intercept",
term == "LBXBPB" ~ "Blood Lead (µg/dL)",
term == "AGE" ~ "Age (years)",
term == "SEX" ~ "Sex (Female vs. Male)",
term == "RACE4CAT" ~ "Race/Ethnicity (vs. Non-Hispanic White)",
term == "EDU4CAT" ~ "Education (vs. <High School)",
term == "INCPOV3CAT" ~ "Income (Low vs. High)",
term == "SMOKING" ~ "Ever Smoker (vs. Never)",
term == "ALCOHOL" ~ "≥12 drinks/year (vs. <12)",
TRUE ~ term
)
) %>%
select(Variable, everything(), -term)
# Create formatted GT table
table2_final <- table2_data %>%
gt() %>%
tab_header(
title = md("**Table 2. Association Between Blood Lead and Hypertension**"),
subtitle = md("Survey-weighted logistic regression results (NHANES 2015-2016); n = 2,079")
) %>%
cols_label(
Variable = "Variable",
OR_unadj = "OR",
CI_unadj = "95% CI",
p_value_unadj = "p-value",
OR_adj = "OR",
CI_adj = "95% CI",
p_value_adj = "p-value"
) %>%
tab_spanner(
label = "Unadjusted Model",
columns = c(OR_unadj, CI_unadj, p_value_unadj)
) %>%
tab_spanner(
label = "Adjusted Model*",
columns = c(OR_adj, CI_adj, p_value_adj)
) %>%
tab_footnote(
footnote = "*Adjusted for age, sex, race/ethnicity, education, income-to-poverty ratio, smoking status, and alcohol consumption",
locations = cells_column_spanners(spanners = "Adjusted Model*")
) %>%
tab_footnote(
footnote = "OR = Odds Ratio; CI = Confidence Interval",
locations = cells_column_labels(columns = OR_unadj)
) %>%
opt_row_striping() %>%
tab_options(
table.font.size = 11,
heading.title.font.size = 14,
heading.subtitle.font.size = 12
)
# Display the table
table2_final
analytic_sample <- analytic_sample %>%
mutate(
RACE4CAT = factor(RACE4CAT,
levels = c(0, 1, 2, 3),
labels = c("Non-Hispanic White",
"Non-Hispanic Black",
"Hispanic",
"Other")),
EDU4CAT = factor(EDU4CAT,
levels = c(0, 1, 2, 3),
labels = c("Less than HS",
"HS Graduate",
"Some College",
"College Graduate"))
)
svy_design <- analytic_sample |>
as_survey_design(
ids = SDMVPSU,
strata = SDMVSTRA,
weights = WTSH2YR,
nest = TRUE
)
# Tests whether blood lead is associated with hypertension without adjustment
unadjusted_model <- svyglm(
HYPERTENSION_status ~ LBXBPB,
design = svy_design,
family = quasibinomial()
)
# View model summary
summary(unadjusted_model)
# Extract coefficients and convert to odds ratios
unadj_results <- tidy(unadjusted_model, conf.int = TRUE, exponentiate = TRUE)
print(unadj_results)
# Tests whether blood lead is independently associated with hypertension
# after controlling for confounders
adjusted_model <- svyglm(
HYPERTENSION_status ~ LBXBPB + AGE + SEX + RACE4CAT + EDU4CAT +
INCPOV3CAT + SMOKING + ALCOHOL,
design = svy_design,
family = quasibinomial()
)
# View model summary
summary(adjusted_model)
# Extract coefficients and convert to odds ratios
adj_results <- tidy(adjusted_model, conf.int = TRUE, exponentiate = TRUE)
print(adj_results)
analytic_sample <- analytic_sample %>%
mutate(
RACE4CAT = factor(RACE4CAT,
levels = c(0, 1, 2, 3),
labels = c("Non-Hispanic White",
"Non-Hispanic Black",
"Hispanic",
"Other")),
EDU4CAT = factor(EDU4CAT,
levels = c(3, 0, 1, 2),
labels = c("Less than HS",
"HS Graduate",
"Some College",
"College Graduate"))
)
svy_design <- analytic_sample |>
as_survey_design(
ids = SDMVPSU,
strata = SDMVSTRA,
weights = WTSH2YR,
nest = TRUE
)
# Tests whether blood lead is associated with hypertension without adjustment
unadjusted_model <- svyglm(
HYPERTENSION_status ~ LBXBPB,
design = svy_design,
family = quasibinomial()
)
# View model summary
summary(unadjusted_model)
# Extract coefficients and convert to odds ratios
unadj_results <- tidy(unadjusted_model, conf.int = TRUE, exponentiate = TRUE)
print(unadj_results)
# Tests whether blood lead is independently associated with hypertension
# after controlling for confounders
adjusted_model <- svyglm(
HYPERTENSION_status ~ LBXBPB + AGE + SEX + RACE4CAT + EDU4CAT +
INCPOV3CAT + SMOKING + ALCOHOL,
design = svy_design,
family = quasibinomial()
)
analytic_sample <- analytic_sample %>%
mutate(
RACE4CAT = factor(RACE4CAT,
levels = c(0, 1, 2, 3),
labels = c("Non-Hispanic White",
"Non-Hispanic Black",
"Hispanic",
"Other")),
EDU4CAT = factor(EDU4CAT,
levels = c(3, 2, 1, 0),  # 3 is NOW reference
labels = c("College Graduate", "Some College",
"HS Graduate", "Less than HS"))
)
svy_design <- analytic_sample |>
as_survey_design(
ids = SDMVPSU,
strata = SDMVSTRA,
weights = WTSH2YR,
nest = TRUE
)
svy_design <- analytic_sample |>
as_survey_design(
ids = SDMVPSU,
strata = SDMVSTRA,
weights = WTSH2YR,
nest = TRUE
)
# Tests whether blood lead is associated with hypertension without adjustment
unadjusted_model <- svyglm(
HYPERTENSION_status ~ LBXBPB,
design = svy_design,
family = quasibinomial()
)
# View model summary
summary(unadjusted_model)
# Extract coefficients and convert to odds ratios
unadj_results <- tidy(unadjusted_model, conf.int = TRUE, exponentiate = TRUE)
print(unadj_results)
# Tests whether blood lead is independently associated with hypertension
# after controlling for confounders
adjusted_model <- svyglm(
HYPERTENSION_status ~ LBXBPB + AGE + SEX + RACE4CAT + EDU4CAT +
INCPOV3CAT + SMOKING + ALCOHOL,
design = svy_design,
family = quasibinomial()
)
View(NHANES_V1)
# Using the final analytic dataset
analytic_sample <- NHANES_V2 |>
filter(ANALYTICSAMPLE == 1)
cat("Final analytic sample size:", nrow(analytic_sample), "\n")
analytic_sample <- analytic_sample %>%
mutate(
# Convert multi-category variables to factors
RACE4CAT = factor(RACE4CAT,
levels = c(0, 1, 2, 3),
labels = c("Non-Hispanic White",
"Non-Hispanic Black",
"Hispanic",
"Other")),
EDU4CAT = factor(EDU4CAT,
levels = c(0, 1, 2, 3),
labels = c("Less than High School",
"High School Graduate",
"Some College",
"College Graduate or Higher")),
# Convert binary variables to factors for clarity
SEX = factor(SEX,
levels = c(1, 2),
labels = c("Male", "Female")),
INCPOV3CAT = factor(INCPOV3CAT,
levels = c(0, 1),
labels = c("High Income (>1.3)",
"Low Income (≤1.3)")),
SMOKING = factor(SMOKING,
levels = c(0, 1),
labels = c("Never Smoker",
"Ever Smoker")),
ALCOHOL = factor(ALCOHOL,
levels = c(0, 1),
labels = c("<12 drinks/year",
"≥12 drinks/year"))
)
analytic_sample <- analytic_sample %>%
mutate(
# Convert multi-category variables to factors
RACE4CAT = factor(RACE4CAT,
levels = c(0, 1, 2, 3),
labels = c("Non-Hispanic White",
"Non-Hispanic Black",
"Hispanic",
"Other")),
EDU4CAT = factor(EDU4CAT,
levels = c(3, 2, 1, 0),  # 3 is NOW reference
labels = c("College Graduate", "Some College",
"HS Graduate", "Less than HS")),
# Convert binary variables to factors for clarity
SEX = factor(SEX,
levels = c(1, 2),
labels = c("Male", "Female")),
INCPOV3CAT = factor(INCPOV3CAT,
levels = c(0, 1),
labels = c("High Income (>1.3)",
"Low Income (≤1.3)")),
SMOKING = factor(SMOKING,
levels = c(0, 1),
labels = c("Never Smoker",
"Ever Smoker")),
ALCOHOL = factor(ALCOHOL,
levels = c(0, 1),
labels = c("<12 drinks/year",
"≥12 drinks/year"))
)
svy_design <- analytic_sample |>
as_survey_design(
ids = SDMVPSU,
strata = SDMVSTRA,
weights = WTSH2YR,
nest = TRUE
)
# Tests whether blood lead is associated with hypertension without adjustment
unadjusted_model <- svyglm(
HYPERTENSION_status ~ LBXBPB,
design = svy_design,
family = quasibinomial()
)
# View model summary
summary(unadjusted_model)
# Extract coefficients and convert to odds ratios
unadj_results <- tidy(unadjusted_model, conf.int = TRUE, exponentiate = TRUE)
print(unadj_results)
# Tests whether blood lead is independently associated with hypertension
# after controlling for confounders
adjusted_model <- svyglm(
HYPERTENSION_status ~ LBXBPB + AGE + SEX + RACE4CAT + EDU4CAT +
INCPOV3CAT + SMOKING + ALCOHOL,
design = svy_design,
family = quasibinomial()
)
# First, check your analytic sample size
cat("Total observations in analytic_sample:", nrow(analytic_sample), "\n\n")
# Check each variable BEFORE converting to factors
cat("=== CHECKING UNIQUE VALUES (BEFORE FACTOR CONVERSION) ===\n\n")
vars_to_check <- c("SEX", "RACE4CAT", "EDU4CAT", "INCPOV3CAT", "SMOKING", "ALCOHOL")
for (var in vars_to_check) {
cat(var, ":\n")
cat("  Unique values:", paste(unique(analytic_sample[[var]]), collapse = ", "), "\n")
cat("  Number of unique:", n_distinct(analytic_sample[[var]], na.rm = TRUE), "\n")
cat("  Frequency table:\n")
print(table(analytic_sample[[var]], useNA = "always"))
cat("\n")
}
# Check for any NAs
cat("=== CHECKING FOR NAs ===\n")
colSums(is.na(analytic_sample[vars_to_check]))
# BEFORE converting to factors
cat("=== CHECKING RAW NUMERIC VALUES ===\n\n")
# Check what values actually exist
cat("SEX values:", sort(unique(analytic_sample$SEX)), "\n")
cat("RACE4CAT values:", sort(unique(analytic_sample$RACE4CAT)), "\n")
cat("EDU4CAT values:", sort(unique(analytic_sample$EDU4CAT)), "\n")
cat("INCPOV3CAT values:", sort(unique(analytic_sample$INCPOV3CAT)), "\n")
cat("SMOKING values:", sort(unique(analytic_sample$SMOKING)), "\n")
cat("ALCOHOL values:", sort(unique(analytic_sample$ALCOHOL)), "\n\n")
# Frequency tables of raw numeric values
cat("EDU4CAT frequency:\n")
print(table(analytic_sample$EDU4CAT, useNA = "always"))
cat("\nRACE4CAT frequency:\n")
print(table(analytic_sample$RACE4CAT, useNA = "always"))
cat("\nSEX frequency:\n")
print(table(analytic_sample$SEX, useNA = "always"))
cat("\nINCPOV3CAT frequency:\n")
print(table(analytic_sample$INCPOV3CAT, useNA = "always"))
cat("\nSMOKING frequency:\n")
print(table(analytic_sample$SMOKING, useNA = "always"))
cat("\nALCOHOL frequency:\n")
print(table(analytic_sample$ALCOHOL, useNA = "always"))
cd E:/COLLEGE/DATA550/Labexercises/Midterm_project
setwd("E:/COLLEGE/DATA550/Labexercises/Midterm_project")
renv::init()
renv::snapshot()
renv::snapshot()
